apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-iot
  namespace: tfg-iot
data:
  grafana-dashboard-iot.json: |
    {
      "id": null,
      "uid": null,
      "title": "Dashboard TFG IoT",
      "timezone": "browser",
      "schemaVersion": 36,
      "version": 1,
      "refresh": "10s",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "timepicker": {
        "refresh_intervals": [
          "5s",
          "10s",
          "30s",
          "1m",
          "5m"
        ]
      },
      "templating": {
        "list": [
          {
            "name": "id_casa",
            "type": "query",
            "label": "Casa",
            "datasource": "CrateDB",
            "query": "SELECT DISTINCT id_casa FROM iot_data",
            "refresh": 1,
            "includeAll": false,
            "multi": false,
            "sort": 1
          },
          {
            "name": "sensor_binario",
            "type": "custom",
            "label": "Sensor Binario",
            "query": "1,2,3,4,5,6,7,8,9",
            "includeAll": false,
            "multi": false,
            "current": {
              "text": "1",
              "value": "1"
            }
          }
        ]
      },
      "panels": [
        {
          "datasource": "CrateDB",
          "title": "Temperatura",
          "type": "timeseries",
          "id": 1,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          },
          "fieldConfig": {
            "defaults": {
              "unit": "celsius"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "datasource": "CrateDB",
              "rawSql": "SELECT time as \"time\", valor['temperature'] FROM iot_data WHERE tipo_dato = 'temperatura' AND id_casa = '$id_casa' AND $__timeFilter(time) ORDER BY time ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Temperatura (Agregado)",
          "type": "timeseries",
          "id": 1001,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          },
          "fieldConfig": {
            "defaults": {
              "unit": "celsius"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "datasource": "CrateDB",
              "rawSql": "SELECT date_trunc('minute', time) AS \"time\", AVG(CAST(valor['temperature'] AS DOUBLE)) FROM iot_data WHERE tipo_dato = 'temperatura' AND id_casa = '$id_casa' AND $__timeFilter(time) GROUP BY 1 ORDER BY 1 ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Humedad",
          "type": "timeseries",
          "id": 2,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "B",
              "datasource": "CrateDB",
              "rawSql": "SELECT time as \"time\", valor['humidity'] FROM iot_data WHERE tipo_dato = 'humedad' AND id_casa = '$id_casa' AND $__timeFilter(time) ORDER BY time ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB", 
          "title": "Humedad (Agregado)",
          "type": "timeseries",
          "id": 1002,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "B",
              "datasource": "CrateDB",
              "rawSql": "SELECT date_trunc('minute', time) AS \"time\", AVG(CAST(valor['humidity'] AS DOUBLE)) FROM iot_data WHERE tipo_dato = 'humedad' AND id_casa = '$id_casa' AND $__timeFilter(time) GROUP BY 1 ORDER BY 1 ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Saturación O₂",
          "type": "timeseries",
          "id": 3,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 8
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "C",
              "datasource": "CrateDB",
              "rawSql": "SELECT time as \"time\", valor['oxygen_saturation'] FROM iot_data WHERE tipo_dato = 'saturacion_oxigeno' AND id_casa = '$id_casa' AND $__timeFilter(time) ORDER BY time ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Saturación O₂ (Agregado)",
          "type": "timeseries",
          "id": 1003,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 8
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "C",
              "datasource": "CrateDB",
              "rawSql": "SELECT date_trunc('minute', time) AS \"time\", AVG(CAST(valor['oxygen_saturation'] AS DOUBLE)) FROM iot_data WHERE tipo_dato = 'saturacion_oxigeno' AND id_casa = '$id_casa' AND $__timeFilter(time) GROUP BY 1 ORDER BY 1 ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Frecuencia Cardiaca",
          "type": "timeseries",
          "id": 4,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 8
          },
          "fieldConfig": {
            "defaults": {
              "unit": "bpm"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "D",
              "datasource": "CrateDB",
              "rawSql": "SELECT time as \"time\", valor['heart_rate'] FROM iot_data WHERE tipo_dato = 'heart_rate' AND id_casa = '$id_casa' AND $__timeFilter(time) ORDER BY time ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Frecuencia Cardiaca (Agregado)",
          "type": "timeseries",
          "id": 1004,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 8
          },
          "fieldConfig": {
            "defaults": {
              "unit": "bpm"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "D",
              "datasource": "CrateDB",
              "rawSql": "SELECT date_trunc('minute', time) AS \"time\", AVG(CAST(valor['heart_rate'] AS DOUBLE)) FROM iot_data WHERE tipo_dato = 'heart_rate' AND id_casa = '$id_casa' AND $__timeFilter(time) GROUP BY 1 ORDER BY 1 ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Certainty Posición",
          "type": "timeseries",
          "id": 5,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 16
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "E",
              "datasource": "CrateDB",
              "rawSql": "SELECT time as \"time\", valor['certainty'] FROM iot_data WHERE tipo_dato = 'posicion' AND id_casa = '$id_casa' AND $__timeFilter(time) ORDER BY time ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Certainty Posición (Agregado)",
          "type": "timeseries",
          "id": 1005,
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 16
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent"
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "E",
              "datasource": "CrateDB",
              "rawSql": "SELECT date_trunc('minute', time) AS \"time\", AVG(CAST(valor['certainty'] AS DOUBLE)) FROM iot_data WHERE tipo_dato = 'posicion' AND id_casa = '$id_casa' AND $__timeFilter(time) GROUP BY 1 ORDER BY 1 ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Sensor Binario Seleccionado",
          "type": "timeseries",
          "id": 6,
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 24
          },
          "fieldConfig": {
            "defaults": {},
            "overrides": []
          },
          "targets": [
            {
              "refId": "Z",
              "datasource": "CrateDB",
              "rawSql": "SELECT time as \"time\", valor[concat('sensor_', '$sensor_binario')]::integer FROM iot_data WHERE tipo_dato = 'binarios' AND id_casa = '$id_casa' AND $__timeFilter(time) ORDER BY time ASC",
              "format": "time_series"
            }
          ],
          "options": {}
        },
        {
          "datasource": "CrateDB",
          "title": "Tabla de Coordenadas (x1, y1, x2, y2)",
          "type": "table",
          "id": 7,
          "gridPos": {
            "h": 10,
            "w": 24,
            "x": 0,
            "y": 32
          },
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "custom": {
                "displayMode": "auto",
                "align": "auto",
                "filterable": true
              }
            },
            "overrides": []
          },
          "targets": [
            {
              "refId": "T",
              "datasource": "CrateDB",
              "rawSql": "SELECT time, valor['x1'] AS x1, valor['y1'] AS y1, valor['x2'] AS x2, valor['y2'] AS y2 FROM iot_data WHERE tipo_dato = 'posicion' AND id_casa = '$id_casa' AND $__timeFilter(time) ORDER BY time DESC",
              "format": "table"
            }
          ],
          "options": {}
        }
      ]
    }